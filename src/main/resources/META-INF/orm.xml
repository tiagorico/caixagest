<?xml version="1.0" encoding="UTF-8" ?>
<entity-mappings xmlns="http://xmlns.jcp.org/xml/ns/persistence/orm"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence/orm
                                     http://xmlns.jcp.org/xml/ns/persistence/orm_2_0.xsd" version="2.1">

    <!-- JPA Named Native Queries -->
    <named-native-query name="GetAllJedi" result-set-mapping="StatsMapping">
        <query>
            WITH
            maxi AS (
            SELECT r.fund_id, max(r.value) val
            FROM rating r
            GROUP BY r.fund_id
            ),
            mini AS (
            SELECT r.fund_id, min(r.value) val
            FROM rating r
            GROUP BY r.fund_id
            ),
            today AS (
            SELECT r.fund_id, r.date, r.value val
            FROM rating r
            WHERE r.date = (
            SELECT max(date)
            FROM rating
            WHERE fund_id = r.fund_id
            )
            ),
            yesterday AS (
            SELECT r.fund_id, r.date, r.value val
            FROM rating r
            WHERE r.date = (
            SELECT max(date) - 2
            FROM rating
            WHERE fund_id = r.fund_id
            )
            ),
            aveg AS (
            SELECT r.fund_id, cast(avg(r.value) AS numeric(36,4)) val
            FROM rating r
            GROUP BY r.fund_id
            )
            SELECT DISTINCT r.fund_id id, fund.name nam, maxi.val max, mini.val min,
            aveg.val avg, today.val today, yesterday.val yesterday
            FROM rating r, fund, maxi, mini, aveg, today, yesterday
            WHERE r.fund_id = maxi.fund_id
            AND r.fund_id = mini.fund_id
            AND r.fund_id = aveg.fund_id
            AND r.fund_id = yesterday.fund_id
            AND r.fund_id = today.fund_id
            AND r.fund_id = fund.id
            ORDER BY r.fund_id
        </query>
    </named-native-query>

    <sql-result-set-mapping name="StatsMapping">
        <constructor-result target-class="com.github.rico.model.dto.StatisticDTO">
            <column name="id"/>
            <column name="name"/>
            <column name="max"/>
            <column name="min"/>
            <column name="avg"/>
            <column name="today"/>
            <column name="yesterday"/>
        </constructor-result>
    </sql-result-set-mapping>

</entity-mappings>